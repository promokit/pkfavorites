document.addEventListener("DOMContentLoaded",(async()=>{if("undefined"==typeof pkfavorites)return void console.error("Promokit Favorites module is not installed properly. Try to reset it.");let t={};const e="add",o="remove",r={sidebar:".js-tab-el-favorites",counter:".js-pkfavorites-counter",dropdown:".js-pkfavorites-container",iconActive:"icon_checked",inProgress:"in_progress",button:".favorites-button",dataAttr:"productsnum",mainParent:prestashop.themeSelectors.listing.product,hidden:prestashop.themeSelectors.alysum.classes.hidden},s=()=>{const t=document.querySelectorAll(r.button);t?.forEach((t=>{t.dataset.listenersAdded||(t.addEventListener("click",a),t.dataset.listenersAdded=!0)}))},a=async o=>{o.preventDefault(),o.target.dataset.pid?((o=>{const{action:r,pid:s}=o.dataset,a=r===e;Object.assign(t,{button:o,url:a?pkfavorites.add:pkfavorites.remove,message:a?pkfavorites.phrases.added:pkfavorites.phrases.removed,buttonTitle:a?pkfavorites.phrases.remove:pkfavorites.phrases.add,state:a?"success":"info",action:r,pid:s})})(o.target),n(!0),await d(),await c(),u(),l(),p(),n(!1),s(),i(t.message,t.state)):i("Invalid product ID","error")},n=e=>{(t.button.querySelector("span")||t.button).classList.toggle(r.inProgress,e)},d=async()=>{const e=`${t.url}&id_product=${t.pid}`;try{const o=await fetch(e,{method:"POST"});if(!o.ok)throw new Error(`Error ${o.status}`);const r=await o.json();if(!r)throw new Error("Empty response");(e=>{t={...t,data:e}})(r)}catch(t){i(t,"error")}},i=(t,e)=>{$.jGrowl(t,{theme:`${$.jGrowl.defaults.theme} ${e}`,header:pkfavorites.phrases.title}),"error"===e&&console.error(t)},c=()=>{t.button.dataset.action={add:o,remove:e}[t.action],t.button.classList.toggle(r.iconActive),t.button.setAttribute("title",t.buttonTitle);const s=t.button.querySelector("span");s&&(s.textContent=t.buttonTitle);const a=t.button.closest(r.sidebar);return t.action!==o||!a&&"module-pkfavorites-account"!==prestashop.page.page_name||t.button.closest(r.mainParent).remove(),m()},u=()=>{const e=document.querySelector(r.dropdown),o=document.querySelector(r.sidebar);o&&(o.innerHTML=t.data.products),e&&(e.innerHTML=t.data.miniproducts,e.parentElement.classList.toggle(r.hidden,t.data.products_number<=0),e.parentElement.style.height="auto")},p=()=>{const e=t.button.querySelector("i");e&&t.data.products_number&&(e.dataset[r.dataAttr]=t.data.products_number,e.textContent=t.data.products_number)},l=()=>{const e=document.querySelector(r.counter);if(!e)return;const o=t.data.products_number||0;e.dataset[r.dataAttr]=o,e.textContent=o},m=()=>new Promise((t=>setTimeout(t,this.animationTime)));s(),prestashop.on("pkelementsTabsReady",(()=>s()))}));